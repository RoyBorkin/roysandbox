<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Pile of Hexagonal Cones with Loft</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/examples/js/exporters/OBJExporter.js"></script>
    <script src="https://rawgit.com/evanw/csg.js/master/build/csg.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #controls { position: absolute; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.7); padding: 10px; border-radius: 5px; }
        input { margin: 5px; }
        button { margin-top: 10px; }
    </style>
</head>
<body>
    <div id="controls">
        <h3>Hexagonal Cone Parameters</h3>
        <label for="numCones">Number of Cones:</label>
        <input type="number" id="numCones" value="10" min="1" max="100" step="1"><br>
        <label for="baseDiameter">Base Diameter:</label>
        <input type="number" id="baseDiameter" value="20" min="1" max="50" step="0.1"><br>
        <label for="topDiameter">Top Diameter:</label>
        <input type="number" id="topDiameter" value="5" min="1" max="50" step="0.1"><br>
        <label for="coneHeight">Cone Height:</label>
        <input type="number" id="coneHeight" value="2" min="0.1" max="10" step="0.1"><br>
        <label for="segments">Segments (Number of Sides):</label>
        <input type="number" id="segments" value="6" min="3" max="12" step="1"><br>
        <label for="loftDiameter">Loft Diameter:</label>
        <input type="number" id="loftDiameter" value="3" min="1" max="6" step="1"><br>
        <button onclick="updateCones()">Update Cones</button><br>
        <button onclick="exportOBJ()">Export OBJ</button>
    </div>

    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Initialize OrbitControls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        let cones = [];
        let numCones = 10;
        let baseDiameter = 20;
        let topDiameter = 5;
        let coneHeight = 2;
        let segments = 6;
        let loftDiameter = 3; // New parameter for loft diameter

        // Function to create a pile of hexagonal cones and a loft
        function createCones() {
            // Clear existing cones and loft
            cones.forEach(cone => scene.remove(cone));
            cones = [];
            const loft = scene.getObjectByName('loft');
            if (loft) scene.remove(loft);

            // Create new cones based on the current parameters
            for (let i = 0; i < numCones-1; i++) {
                const diameter = baseDiameter - (baseDiameter - topDiameter) * (i / (numCones - 1)); // Gradually change the diameter
                const geometry = createHexagonalCone(diameter, topDiameter, coneHeight, segments);
                const material = new THREE.MeshBasicMaterial({ color: Math.random() * 0xffffff });
                const cone = new THREE.Mesh(geometry, material);
                cone.position.y = i * coneHeight; // Stack cones vertically
                scene.add(cone);
                cones.push(cone);
            }

            // Create the loft geometry
            const loftGeometry = new THREE.CylinderGeometry(loftDiameter / 2, loftDiameter / 2, (numCones * coneHeight) + 6, 6);
            const loftMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.5 });
            const loftMesh = new THREE.Mesh(loftGeometry, loftMaterial);
            loftMesh.position.y = (numCones * coneHeight) / 2 - 3; // Position the loft in the middle
            loftMesh.name = 'loft'; // Name the loft for easy reference
            scene.add(loftMesh);
            const loftMesh2 = new THREE.Mesh(loftGeometry, loftMaterial);
            loftMesh2.position.y = loftMesh.position.y
            loftMesh2.name = 'loft2'; // Name the loft for easy reference
            scene.add(loftMesh2);
        }

        // Function to create a hexagonal cone
        function createHexagonalCone(baseDiameter, topDiameter, height, segments) {
            const baseRadius = baseDiameter / 2;
            const topRadius = topDiameter / 2;

            const geometry = new THREE.CylinderGeometry(topRadius, baseRadius, height, segments);
            return geometry;
        }

        // Function to update parameters and regenerate the cones and loft
        function updateCones() {
            numCones = parseInt(document.getElementById("numCones").value);
            baseDiameter = parseFloat(document.getElementById("baseDiameter").value);
            topDiameter = parseFloat(document.getElementById("topDiameter").value);
            coneHeight = parseFloat(document.getElementById("coneHeight").value);
            segments = parseInt(document.getElementById("segments").value);
            loftDiameter = parseFloat(document.getElementById("loftDiameter").value); // Get loft diameter
            createCones(); // Update the cones and loft
        }

        // Export the model as OBJ (with separate bodies)
        function exportOBJ() {
            const exporter = new THREE.OBJExporter();
            // Export the entire scene (all separate cones and loft in the scene)
            const objData = exporter.parse(scene);

            const blob = new Blob([objData], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'pile_of_hexagonal_cones_with_loft.obj'; // Download filename
            link.click(); // Trigger the download
        }

        // Set initial scene and camera position
        camera.position.z = 50;

        // Animate the scene
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // Update controls (needed for smooth interaction)
            renderer.render(scene, camera);
        }
        animate();

        // Initialize the cones and loft with default parameters
        createCones();

    </script>
</body>
</html>